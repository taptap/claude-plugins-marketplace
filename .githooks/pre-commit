#!/usr/bin/env bash
set -euo pipefail

src_dir="plugins/git/skills/git-flow/snippets"
dst_dir="plugins/sync/skills/cursor-templates/rules/git-flow/snippets"
sync_script="plugins/sync/scripts/sync-git-flow-snippets.sh"

if ! git rev-parse --is-inside-work-tree >/dev/null 2>&1; then
  exit 0
fi

# 仅当 snippets 有改动时才触发
staged_changes="$(git diff --cached --name-only -- "${src_dir}" || true)"
unstaged_changes="$(git diff --name-only -- "${src_dir}" || true)"

if [[ -z "${staged_changes}" && -z "${unstaged_changes}" ]]; then
  exit 0
fi

# 为了保证同步基于的 working tree 与提交的 index 一致，要求 snippets 的改动必须全部暂存
if [[ -n "${unstaged_changes}" ]]; then
  {
    echo "[pre-commit] 检测到 git-flow snippets 有未暂存改动："
    echo "${unstaged_changes}"
    echo ""
    echo "[pre-commit] 请先暂存该目录的改动再提交："
    echo "  git add ${src_dir}/"
  } >&2
  exit 1
fi

if [[ ! -x "${sync_script}" ]]; then
  echo "[pre-commit] 未找到可执行脚本：${sync_script}" >&2
  echo "[pre-commit] 请确认文件存在且可执行（chmod +x）。" >&2
  exit 1
fi

echo "[pre-commit] 检测到 git-flow snippets 变更，正在同步到 sync 插件目录..."
"${sync_script}"

# 如果同步导致目标目录变化，自动 add，确保提交内容一致
if ! git diff --quiet -- "${dst_dir}"; then
  git add "${dst_dir}"
  echo "[pre-commit] 已自动暂存同步产物：${dst_dir}"
else
  echo "[pre-commit] 同步完成：目标目录无变化"
fi

exit 0
