# 置信度评分规则

本文档定义 quality plugin 的置信度评分标准，确保所有 Agent 使用统一的评分规则。

## 评分范围

所有问题的置信度评分范围：**0-100**

- **0-49**：低置信度，不应报告
- **50-69**：中等置信度，标记为"需要人工确认"
- **70-89**：较高置信度，可能存在问题
- **90-100**：高置信度，确定存在问题

## 默认阈值

**置信度阈值：80**

- **≥ 80**：直接报告
- **< 80**：标记为"需要人工确认"

## 按维度的评分标准

### 1. Bug 检测

| 置信度 | 标准 | 示例 |
|--------|------|------|
| **90-100** | 明确的 Bug，必然导致错误 | nil 指针解引用、数组越界、资源未关闭 |
| **70-89** | 很可能是 Bug，需要进一步确认 | 可能的数据竞争、潜在的死锁 |
| **50-69** | 潜在 Bug，取决于上下文 | 边界条件可能未处理、错误可能被忽略 |
| **<50** | 不确定，不应报告 | 主观猜测、缺乏证据 |

**示例：**
```go
// 置信度 95 - 明确的 nil 指针问题
data.Process()  // data 未检查 nil

// 置信度 75 - 可能的数据竞争
go func() {
    sharedVar++  // 没有锁保护，可能竞争
}()

// 置信度 60 - 潜在的边界问题
items[index]  // index 可能越界，需要看上下文
```

### 2. 代码质量

| 置信度 | 标准 | 示例 |
|--------|------|------|
| **90-100** | 明确的质量问题，有具体度量标准 | 函数 200 行、圈复杂度 30 |
| **70-89** | 较明显的质量问题 | 函数 80 行、重复代码、命名不清 |
| **50-69** | 可改进的地方 | 函数 60 行、嵌套 4 层、注释不足 |
| **<50** | 主观建议，不应报告 | 个人编码风格偏好 |

**示例：**
```go
// 置信度 95 - 明确的质量问题（可度量）
func Process() error {
    // ... 200 lines of code ...
}

// 置信度 80 - 明显的重复代码
if user.IsAdmin() {
    log.Info("admin action")
    db.Save(user)
    cache.Set(user.ID, user)
}
// ... 30 行后相同的代码再次出现

// 置信度 60 - 可改进但不严重
func p(u *User) error {  // 命名可以更清晰
    // ...
}
```

### 3. 安全检查

| 置信度 | 标准 | 示例 |
|--------|------|------|
| **90-100** | 明确的安全漏洞，可直接利用 | SQL 注入、XSS、硬编码密码 |
| **70-89** | 很可能是安全问题，需要验证 | 可能的路径遍历、弱加密 |
| **50-69** | 潜在安全风险，取决于上下文 | 日志可能包含敏感信息 |
| **<50** | 安全建议，不应报告为漏洞 | 一般性安全最佳实践 |

**示例：**
```go
// 置信度 98 - 明确的 SQL 注入
query := "SELECT * FROM users WHERE id = " + userId
db.Query(query)

// 置信度 85 - 可能的路径遍历
filePath := "/var/data/" + userInput  // 未验证 userInput
os.Open(filePath)

// 置信度 65 - 潜在的敏感日志
log.Info("user login", user.Email, user.Password)  // 密码应该脱敏
```

### 4. 性能问题

| 置信度 | 标准 | 示例 |
|--------|------|------|
| **90-100** | 明确的性能问题，有具体度量标准 | O(n²) 算法、N+1 查询 |
| **70-89** | 很可能的性能瓶颈 | 循环中的字符串拼接、频繁的小 I/O |
| **50-69** | 潜在性能优化点 | 可以用指针传递大对象 |
| **<50** | 微优化，不应报告 | 极端情况下的性能优化 |

**示例：**
```go
// 置信度 95 - 明确的 N+1 查询
for _, userId := range userIds {  // 100 个 userId
    db.Query("SELECT * FROM users WHERE id = ?", userId)
}

// 置信度 80 - 明显的字符串拼接问题
var result string
for i := 0; i < 10000; i++ {
    result += fmt.Sprintf("%d,", i)  // 应该用 strings.Builder
}

// 置信度 60 - 可优化但影响不大
func Process(data [1024]byte) {  // 可以传指针
    // ...
}
```

## 冗余加成机制

当**同一维度的 2 个 Agent** 都发现**同一问题**时，置信度 **+20**。

### 判定标准（同一问题）

同时满足以下条件：
1. **相同文件**：`file` 字段相同
2. **相同行号**：`line` 字段相同（允许 ±2 行误差）
3. **相似描述**：`message` 关键词相似度 > 70%

### 示例

```json
// Agent 1 输出
{
  "agent": "bug-detector-1",
  "findings": [{
    "file": "app/service/consume.go",
    "line": 156,
    "confidence": 70,
    "message": "未检查 nil 就调用 data.Process()"
  }]
}

// Agent 2 输出
{
  "agent": "bug-detector-2",
  "findings": [{
    "file": "app/service/consume.go",
    "line": 156,
    "confidence": 75,
    "message": "data 可能为 nil，调用 Process() 会 panic"
  }]
}

// 合并后（取最高置信度 + 20）
{
  "confidence": 95,  // max(70, 75) + 20
  "message": "未检查 nil 就调用 data.Process()（2 个 Agent 确认）"
}
```

## 评分指导原则

### 1. 客观性原则
优先使用可度量的标准：
- ✅ 函数长度 > 50 行
- ✅ 圈复杂度 > 10
- ✅ 明确的安全漏洞类型
- ❌ "这段代码写得不好"

### 2. 证据原则
基于代码证据，不做无根据的推测：
- ✅ 代码中明确存在问题
- ✅ 可以指出具体的问题位置
- ❌ "可能有问题"但无法指出具体位置

### 3. 影响原则
考虑问题的实际影响：
- **High** → 置信度 +10
- **Medium** → 置信度 ±0
- **Low** → 置信度 -10

### 4. 上下文原则
考虑代码上下文：
- 如果缺乏上下文无法判断 → 降低置信度 20
- 如果上下文表明问题不存在 → 不报告

## 特殊情况处理

### 1. 误报风险高的情况

降低置信度 20-30：
- 代码使用了不常见的模式
- 可能有特殊的业务逻辑
- 框架/库的特殊用法

### 2. 历史问题

**不报告**已存在代码的问题：
- 只检查新增或修改的代码
- 即使发现已存在问题，置信度设为 0

### 3. 工具可检测问题

**不报告** linter/编译器可检测的问题：
- Go 的 `go vet` 可检测 → 不报告
- golangci-lint 可检测 → 不报告
- 编译错误 → 不报告

## 阈值调整建议

根据项目需求，可以调整置信度阈值：

| 场景 | 建议阈值 | 理由 |
|------|---------|------|
| **生产环境发布前** | 70 | 更严格，减少风险 |
| **日常开发** | 80（默认） | 平衡准确性和工作量 |
| **代码重构** | 85 | 只关注最明确的问题 |
| **新手代码审查** | 75 | 提供更多学习机会 |

## 置信度校准

定期根据误报率校准评分：

| 误报率 | 行动 |
|--------|------|
| < 5% | 保持当前标准 |
| 5-10% | 轻微提高阈值（+5） |
| 10-20% | 提高阈值（+10） |
| > 20% | 显著提高阈值（+15）或调整 Agent prompt |

## 输出示例

```json
{
  "file": "app/service/consume.go",
  "line": 156,
  "type": "Bug",
  "severity": "high",
  "confidence": 95,
  "message": "未检查 nil 就调用 data.Process()（2 个 Agent 确认）",
  "suggestion": "添加 nil 检查：if data != nil { data.Process() }",
  "redundancy_bonus": true,
  "agents": ["bug-detector-1", "bug-detector-2"]
}
```

## 总结

置信度评分的核心目标：
1. **减少误报**：只报告高置信度问题
2. **提供依据**：说明为什么是问题
3. **可执行建议**：告诉如何修复
4. **持续改进**：根据反馈调整标准
